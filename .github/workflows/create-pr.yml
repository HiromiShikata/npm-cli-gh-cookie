name: Create PR

on:
  push:
    branches-ignore:
      - main

jobs:
  create_and_enable_automerge:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set branch name as output
        id: branch_name
        run: echo "branch=${GITHUB_REF#refs/heads/}" >> "$GITHUB_OUTPUT"

      - name: Get or create Pull Request number
        id: pr_number
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN || github.token }}
        run: |
          BRANCH="${{ steps.branch_name.outputs.branch }}"
          EXISTING=$(gh pr list --head "$BRANCH" --base main --json number --jq '.[0].number // empty')
          if [ -n "$EXISTING" ]; then
            echo "value=$EXISTING" >> "$GITHUB_OUTPUT"
          else
            if NUMBER=$(gh pr create \
              --head "$BRANCH" \
              --base main \
              --title "$BRANCH" \
              --body ':magic_wand: :sparkles:' \
              --json number \
              --jq '.number'); then
              if [ -z "$NUMBER" ]; then
                echo "Failed to determine pull request number after creation" >&2
                exit 1
              fi
              echo "value=$NUMBER" >> "$GITHUB_OUTPUT"
            else
              echo "gh pr create failed, re-checking for existing pull request..." >&2
              EXISTING_AFTER=$(gh pr list --head "$BRANCH" --base main --json number --jq '.[0].number // empty')
              if [ -n "$EXISTING_AFTER" ]; then
                echo "value=$EXISTING_AFTER" >> "$GITHUB_OUTPUT"
              else
                echo "Failed to create or find pull request for branch '$BRANCH'" >&2
                exit 1
              fi
            fi
          fi

      - name: Assign PR to author
        if: steps.pr_number.outputs.value
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN || github.token }}
        run: |
          if ! gh pr edit ${{ steps.pr_number.outputs.value }} --add-assignee "${{ github.actor }}"; then
            echo "Error: Failed to assign PR #${{ steps.pr_number.outputs.value }} to ${{ github.actor }}. This may indicate missing permissions or a misconfigured GH_TOKEN." >&2
            exit 1
          fi

      - name: Enable Auto Merge for PR
        if: steps.pr_number.outputs.value
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN || github.token }}
        run: |
          if ! gh pr merge ${{ steps.pr_number.outputs.value }} --auto --merge; then
            echo "Error: Failed to enable auto-merge for PR #${{ steps.pr_number.outputs.value }}. This may indicate missing permissions, branch protection rules not configured for auto-merge, or that the PR does not meet merge requirements." >&2
            exit 1
          fi
